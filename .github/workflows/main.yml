on: [push]

jobs:
  test_ubt_build_action:
    runs-on: ubuntu-latest
    name: Test ufbt action
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup ufbt
        uses: ./ # Uses an action in the root directory
        with:
          ufbt-version: 'prerelease'
          sdk-channel: 'dev'
          task: 'none'

      - name: Create app
        id: create-app
        shell: bash
        run: |
          mkdir test; cd test
          ufbt create APPID=test

      - name: Build test app
        uses: ./
        id: build-app
        with:
          skip-setup: true
          path: 'test'

      - name: Build test app for unleashed
        uses: ./
        id: build-app-unleashed
        with:
          skip-setup: true
          path: 'test'
          sdk-channel: 'dev'
          sdk-index-url: https://up.unleashedflip.com/directory.json

      - name: Upload app artifacts
        uses: actions/upload-artifact@v3
        with:
          name: fap-${{ steps.build-app.outputs.suffix }}
          path: ${{ steps.build-app.outputs.fap-artifacts }}

      - name: Break app
        id: break-app
        shell: bash
        run: |
          echo "static int testmain(int unused_i) { return 1; }" >> test/test.c

      - name: Lint broken app
        uses: ./
        id: lint-broken-app
        continue-on-error: true
        with:
          skip-setup: true
          path: 'test'
          task: 'lint'

      - name: Build broken app
        uses: ./
        id: build-broken-app
        continue-on-error: true
        with:
          skip-setup: true
          path: 'test'

      - name: Fail if lint succeeded
        if: steps.lint-broken-app.outcome == 'success' || steps.build-broken-app.outcome == 'success'
        run: exit 1
